<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enterprise Payroll System</title>

<!-- CDN Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: Segoe UI, sans-serif;
    background: #f4f6f9;
  }
  .login-box,
  .section-box {
    max-width: 500px;
    margin: 30px auto;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  input,
  select {
    width: 100%;
    padding: 8px;
    margin: 6px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    background: #1565c0;
    color: white;
    cursor: pointer;
  }
  button:hover {
    opacity: 0.9;
  }
  header {
    background: #0d47a1;
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  section {
    background: white;
    padding: 20px;
    margin: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th {
    background: #0d47a1;
    color: white;
  }
  th,
  td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }
  .card-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .card {
    flex: 1;
    background: #e3f2fd;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
  }
  .hidden {
    display: none;
  }
  .container {
    max-width: 1100px;
    margin: auto;
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginSection" class="login-box">
  <h2>Enterprise Payroll Login</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color: red;"></p>
</div>

<!-- APP -->
<div id="appSection" class="hidden">
  <header>
    <h2>Enterprise Payroll System</h2>
    <div>
      <span id="userEmail"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="container">
    <section>
      <h3>Dashboard Summary</h3>
      <div class="card-container">
        <div class="card">
          Employees<br /><span id="totalEmployees">0</span>
        </div>
        <div class="card">
          Total Payroll<br />₱<span id="totalPayroll">0.00</span>
        </div>
        <div class="card">
          Total Deductions<br />₱<span id="totalDeduction">0.00</span>
        </div>
      </div>
      <canvas id="chart"></canvas>
    </section>

    <section class="section-box">
      <h3>Add Employee</h3>
      <input type="text" id="empName" placeholder="Employee Name" />
      <input type="text" id="empPosition" placeholder="Position" />
      <input type="number" id="empSalary" placeholder="Salary" />
      <button id="addEmployee">Add Employee</button>
    </section>

    <section class="section-box">
      <h3>Add Payroll</h3>
      <select id="empSelect"></select>
      <select id="monthSelect">
        <option>January</option>
        <option>February</option>
        <option>March</option>
        <option>April</option>
        <option>May</option>
        <option>June</option>
        <option>July</option>
        <option>August</option>
        <option>September</option>
        <option>October</option>
        <option>November</option>
        <option>December</option>
      </select>
      <input type="number" id="grossPay" placeholder="Gross Pay" />
      <input type="number" id="deduction" placeholder="Deduction" />
      <button id="addPayroll">Save Payroll</button>
    </section>

    <section>
      <h3>Payroll Records</h3>
      <button id="exportExcel">Export to Excel</button>
      <table id="payrollTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Month</th>
            <th>Gross</th>
            <th>Deduction</th>
            <th>Net</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCDhTfNVO5jTqredgHe9t7emxOlvGMczxM",
    authDomain: "enterprise-payroll-2026.firebaseapp.com",
    projectId: "enterprise-payroll-2026",
    storageBucket: "enterprise-payroll-2026.appspot.com",
    messagingSenderId: "877928180953",
    appId: "1:877928180953:web:3b09060848347031c1e2c8",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const loginSection = document.getElementById("loginSection");
  const appSection = document.getElementById("appSection");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginError = document.getElementById("loginError");
  const userEmail = document.getElementById("userEmail");

  const empName = document.getElementById("empName");
  const empPosition = document.getElementById("empPosition");
  const empSalary = document.getElementById("empSalary");
  const addEmployee = document.getElementById("addEmployee");

  const empSelect = document.getElementById("empSelect");
  const monthSelect = document.getElementById("monthSelect");
  const grossPay = document.getElementById("grossPay");
  const deduction = document.getElementById("deduction");
  const addPayroll = document.getElementById("addPayroll");

  const totalEmployees = document.getElementById("totalEmployees");
  const totalPayroll = document.getElementById("totalPayroll");
  const totalDeduction = document.getElementById("totalDeduction");

  const exportExcel = document.getElementById("exportExcel");

  let employees = [];
  let payrolls = [];
  let chart;

  // AUTH STATE LISTENER
  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      userEmail.innerText = user.email;
      loadEmployees();
      loadPayroll();
    } else {
      loginSection.classList.remove("hidden");
      appSection.classList.add("hidden");
    }
  });

  // LOGIN
  loginBtn.addEventListener("click", async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    loginError.innerText = "";

    if (!email || !password) {
      loginError.innerText = "Please enter email and password.";
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      if (error.code === "auth/user-not-found") {
        loginError.innerText = "User not found.";
      } else if (error.code === "auth/wrong-password") {
        loginError.innerText = "Wrong password.";
      } else if (error.code === "auth/invalid-email") {
        loginError.innerText = "Invalid email format.";
      } else {
        loginError.innerText = error.message;
      }
    }
  });

  // LOGOUT
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // ADD EMPLOYEE
  addEmployee.addEventListener("click", async () => {
    if (!empName.value || !empPosition.value || !empSalary.value) {
      alert("Please fill all fields");
      return;
    }
    await addDoc(collection(db, "employees"), {
      name: empName.value,
      position: empPosition.value,
      salary: parseFloat(empSalary.value),
    });
    empName.value = "";
    empPosition.value = "";
    empSalary.value = "";
    loadEmployees();
  });

  // LOAD EMPLOYEES
  async function loadEmployees() {
    const snapshot = await getDocs(collection(db, "employees"));
    employees = [];
    empSelect.innerHTML = "";
    snapshot.forEach((doc) => {
      employees.push(doc.data());
      const option = document.createElement("option");
      option.value = doc.data().name;
      option.innerText = doc.data().name;
      empSelect.appendChild(option);
    });
    totalEmployees.innerText = employees.length;
  }

  // ADD PAYROLL
  addPayroll.addEventListener("click", async () => {
    if (!grossPay.value || !deduction.value) {
      alert("Please fill all fields");
      return;
    }
    const net = parseFloat(grossPay.value) - parseFloat(deduction.value);
    await addDoc(collection(db, "payrolls"), {
      name: empSelect.value,
      month: monthSelect.value,
      gross: parseFloat(grossPay.value),
      deduction: parseFloat(deduction.value),
      net,
    });
    grossPay.value = "";
    deduction.value = "";
    loadPayroll();
  });

  // LOAD PAYROLL
  async function loadPayroll() {
    const snapshot = await getDocs(collection(db, "payrolls"));
    payrolls = [];
    const tbody = document.querySelector("#payrollTable tbody");
    tbody.innerHTML = "";
    snapshot.forEach((doc) => {
      const p = doc.data();
      payrolls.push(p);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.month}</td>
        <td>₱${p.gross.toFixed(2)}</td>
        <td>₱${p.deduction.toFixed(2)}</td>
        <td>₱${p.net.toFixed(2)}</td>
        <td><button onclick='generatePayslip(${JSON.stringify(
          p
        )})'>Payslip</button></td>
      `;
      tbody.appendChild(tr);
    });
    updateDashboard();
  }

  // UPDATE DASHBOARD
  function updateDashboard() {
    const totalNet = payrolls.reduce((a, b) => a + b.net, 0);
    const totalDed = payrolls.reduce((a, b) => a + b.deduction, 0);
    totalPayroll.innerText = totalNet.toFixed(2);
    totalDeduction.innerText = totalDed.toFixed(2);

    const months = {};
    payrolls.forEach((p) => {
      months[p.month] = (months[p.month] || 0) + p.net;
    });

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById("chart"), {
      type: "bar",
      data: {
        labels: Object.keys(months),
        datasets: [
          {
            label: "Monthly Payroll",
            data: Object.values(months),
            backgroundColor: "#0d47a1",
          },
        ],
      },
    });
  }

  // EXPORT EXCEL
  exportExcel.addEventListener("click", () => {
    const wb = XLSX.utils.table_to_book(document.getElementById("payrollTable"));
    XLSX.writeFile(wb, "Payroll_Report.xlsx");
  });

  // PDF PAYSLIP
  window.generatePayslip = (p) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Enterprise Payroll System", 20, 20);
    doc.text(`Name: ${p.name}`, 20, 40);
    doc.text(`Month: ${p.month}`, 20, 50);
    doc.text(`Gross: ₱${p.gross.toFixed(2)}`, 20, 60);
    doc.text(`Deduction: ₱${p.deduction.toFixed(2)}`, 20, 70);
    doc.text(`Net: ₱${p.net.toFixed(2)}`, 20, 80);
    doc.save(`Payslip_${p.name}_${p.month}.pdf`);
  };
</script>

</body>
</html>
